---
layout: documentation
title: Malloy Documentation
footer: /generated/footers/examples/iowa/step6.html
---

<div class="document">
      <h1>
        <a id="dashboards" class="header-link anchor" href="#dashboards">
          Dashboards
        </a>
      </h1>
    <p>Putting it all together we can write a dashboard</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">vendor_dashboard</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">vendor_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">(</span><span style="color: #795E26">distinct</span><span style="color: #000000"> </span><span style="color: #001080">vendor_number</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">total_sale_dollars</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">total_bottles</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">by_month</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">by_class</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">by_vendor_bar_chart</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">top_sellers_by_revenue</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">most_expensive_products</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">by_vendor_dashboard</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #AF00DB">top</span><span style="color: #000000">: </span><span style="color: #098658">10</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">vendor_name</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_sale_dollars</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">by_month</span><span style="color: #000000">, </span><span style="color: #001080">top_sellers_by_revenue</span><span style="color: #000000">, </span><span style="color: #001080">most_expensive_products</span></span>
<span class="line"><span style="color: #000000">    }</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre>
      <h2>
        <a id="run-dashboard" class="header-link anchor" href="#run-dashboard">
          Run Dashboard
        </a>
      </h2>
    <p>Simply add some filters.  Notice the sub-dashboard for each of the Vendors.</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">iowa</span><span style="color: #000000"> { </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">category_class</span><span style="color: #000000"> = </span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000"> } -&gt; </span><span style="color: #001080">vendor_dashboard</span></span></pre><div class="result-outer large">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner">
        <div><div style="position: relative;"><div class="dimensions" style="display: flex; flex-wrap: wrap;"></div><div class="dashboard-outer" style="display: flex; flex-direction: row; font-size: 11px;"><div style="display: flex; flex-wrap: wrap;"><div style="margin: 6px; border-radius: 5px; padding: 10px; flex: 1 0 auto; box-shadow: 0 1px 5px 0 var(--malloy-tile-background-color, #f3f3f3); max-width: calc(100% - 11px); display: flex; flex-direction: column; overflow: hidden;"><div style="font-size: 11px; font-family: var(--malloy-font-family, &quot;Roboto&quot;); font-weight: 500;">vendor_count</div><div style="display: flex; flex-direction: column; justify-content: center; flex: 1 0 auto;"><div style="font-size: 20px; display: flex; justify-content: center; align-items: center; margin-top: 5px;"><span>259</span></div></div></div><div style="margin: 6px; border-radius: 5px; padding: 10px; flex: 1 0 auto; box-shadow: 0 1px 5px 0 var(--malloy-tile-background-color, #f3f3f3); max-width: calc(100% - 11px); display: flex; flex-direction: column; overflow: hidden;"><div style="font-size: 11px; font-family: var(--malloy-font-family, &quot;Roboto&quot;); font-weight: 500;">total_sale_dollars</div><div style="display: flex; flex-direction: column; justify-content: center; flex: 1 0 auto;"><div style="font-size: 20px; display: flex; justify-content: center; align-items: center; margin-top: 5px;"><span>832,983,145.53</span></div></div></div><div style="margin: 6px; border-radius: 5px; padding: 10px; flex: 1 0 auto; box-shadow: 0 1px 5px 0 var(--malloy-tile-background-color, #f3f3f3); max-width: calc(100% - 11px); display: flex; flex-direction: column; overflow: hidden;"><div style="font-size: 11px; font-family: var(--malloy-font-family, &quot;Roboto&quot;); font-weight: 500;">total_bottles</div><div style="display: flex; flex-direction: column; justify-content: center; flex: 1 0 auto;"><div style="font-size: 20px; display: flex; justify-content: center; align-items: center; margin-top: 5px;"><span>77,425,297</span></div></div></div><div style="margin: 6px; border-radius: 5px; padding: 10px; flex: 1 0 auto; box-shadow: 0 1px 5px 0 var(--malloy-tile-background-color, #f3f3f3); max-width: calc(100% - 11px); display: flex; flex-direction: column; overflow: hidden;"><div style="font-size: 11px; font-family: var(--malloy-font-family, &quot;Roboto&quot;); font-weight: 500;">top_sellers_by_revenue</div><div style="display: flex; flex-direction: column; justify-content: center; flex: 1 0 auto;"><div style="display: flex; justify-content: center; align-items: center; flex-direction: column;"><table style="vertical-align: top; border-collapse: collapse; width: 100%;"><thead><tr><th style="padding: 8px; text-align: left;">vendor_​name</th><th style="padding: 8px; text-align: left;">item_​description</th><th style="padding: 8px; text-align: right;">total_​sale_​dollars</th><th style="padding: 8px; text-align: right;">total_​bottles</th><th style="padding: 8px; text-align: right;">avg_​price_​per_​100ml</th><th style="padding: 8px; text-align: right;">percent_​of_​sales</th></tr></thead><tbody><tr><td style="padding: 8px; vertical-align: top;"><span>FIFTH GENERATION INC</span></td><td style="padding: 8px; vertical-align: top;"><span>TITOS HANDMADE VODKA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>126,822,016.01</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>6,653,110</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1.909</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>15.225</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>LUXCO-ST LOUIS</span></td><td style="padding: 8px; vertical-align: top;"><span>HAWKEYE VODKA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>45,592,405.7</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>6,665,496</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>0.656</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5.473</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>PERNOD RICARD USA/AUSTIN NICHOLS</span></td><td style="padding: 8px; vertical-align: top;"><span>ABSOLUT SWEDISH VODKA 80 PRF</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>30,807,306.95</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,540,991</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2.209</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.698</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>BACARDI U.S.A., INC.</span></td><td style="padding: 8px; vertical-align: top;"><span>GREY GOOSE VODKA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>26,132,537.45</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,117,162</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.515</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.137</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>LAIRD AND COMPANY</span></td><td style="padding: 8px; vertical-align: top;"><span>FIVE O'CLOCK VODKA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>23,837,025.5</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,013,220</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>0.667</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2.862</span></td></tr></tbody></table></div></div></div></div></div></div></div>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;vendor_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">259</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">832983145.5301263</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">77425297</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;top_sellers_by_revenue&quot;</span><span style="color: #000000">: [</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;vendor_name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;FIFTH GENERATION INC&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;item_description&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;TITOS HANDMADE VODKA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">126822016.01000415</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6653110</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_price_per_100ml&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1.909243436347666</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_sales&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15.225039869119106</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;vendor_name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;LUXCO-ST LOUIS&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;item_description&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;HAWKEYE VODKA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">45592405.700002894</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6665496</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_price_per_100ml&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.6559549138207256</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_sales&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5.473388740775423</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;vendor_name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;PERNOD RICARD USA/AUSTIN NICHOLS&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;item_description&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;ABSOLUT SWEDISH VODKA 80 PRF&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">30807306.94999938</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1540991</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_price_per_100ml&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2.2090022725748</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_sales&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.6984310085161476</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;vendor_name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;BACARDI U.S.A., INC.&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;item_description&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;GREY GOOSE VODKA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">26132537.45</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1117162</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_price_per_100ml&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.514731246362297</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_sales&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.1372228346071465</span></span>
<span class="line"><span style="color: #000000">      },</span></span>
<span class="line"><span style="color: #000000">      {</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;vendor_name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;LAIRD AND COMPANY&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;item_description&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;FIVE O&#39;CLOCK VODKA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_sale_dollars&quot;</span><span style="color: #000000">: </span><span style="color: #098658">23837025.499998793</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;total_bottles&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4013220</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;avg_price_per_100ml&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.6671263194071875</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0451A5">&quot;percent_of_sales&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2.8616455960616656</span></span>
<span class="line"><span style="color: #000000">      }</span></span>
<span class="line"><span style="color: #000000">    ]</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">count</span><span style="color: #000000">(</span><span style="color: #0000FF">distinct</span><span style="color: #000000"> iowa.vendor_number)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> vendor_count__0,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.sale_dollars),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_sale_dollars__0,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.bottles_sold),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_bottles__0,</span></span>
<span class="line"><span style="color: #000000">    __lateral_join_bag.vendor_name__1,</span></span>
<span class="line"><span style="color: #000000">    __lateral_join_bag.item_description__1,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.sale_dollars),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_sale_dollars__1,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.bottles_sold),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_bottles__1,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">AVG</span><span style="color: #000000">((iowa.state_bottle_retail/</span><span style="color: #795E26">nullif</span><span style="color: #000000">(iowa.bottle_volume_ml,</span><span style="color: #098658">0</span><span style="color: #000000">)*</span><span style="color: #098658">100</span><span style="color: #000000">))</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> avg_price_per_100ml__1,</span></span>
<span class="line"><span style="color: #000000">    (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.sale_dollars),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)/</span><span style="color: #795E26">MAX</span><span style="color: #000000">((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(iowa.sale_dollars),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000">)) </span><span style="color: #0000FF">OVER</span><span style="color: #000000"> ()*</span><span style="color: #098658">100</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> percent_of_sales__1</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.iowa_liquor_sales.sales_deduped`</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> iowa</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span><span style="color: #795E26">row_number</span><span style="color: #000000">() </span><span style="color: #0000FF">OVER</span><span style="color: #000000">() -</span><span style="color: #098658">1</span><span style="color: #000000">  group_set </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> UNNEST(GENERATE_ARRAY(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)))</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> UNNEST([STRUCT(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">    iowa.vendor_name</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> vendor_name__1,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">    iowa.item_description</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> item_description__1)]) </span><span style="color: #0000FF">as</span><span style="color: #000000"> __lateral_join_bag</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> ((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(WHISK|SCOTCH|BOURBON|RYE)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;WHISKIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;VODKA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;RUM&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;RUMS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;TEQUILA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;TEQUILAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(LIQUE|AMARETTO|TRIPLE SEC)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;LIQUEURS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;BRAND(I|Y)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;BRANDIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;GIN&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;GINS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;SCHNAP&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;SCHNAPPS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;OTHER&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">)=</span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">AND</span><span style="color: #000000"> ((</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(WHISK|SCOTCH|BOURBON|RYE)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;WHISKIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;VODKA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;RUM&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;RUMS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;TEQUILA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;TEQUILAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(LIQUE|AMARETTO|TRIPLE SEC)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;LIQUEURS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;BRAND(I|Y)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;BRANDIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;GIN&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;GINS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;SCHNAP&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;SCHNAPPS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;OTHER&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">)=</span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">AND</span><span style="color: #000000"> ((group_set </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">OR</span><span style="color: #000000"> (group_set </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">AND</span><span style="color: #000000"> (</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(WHISK|SCOTCH|BOURBON|RYE)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;WHISKIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;VODKA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;RUM&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;RUMS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;TEQUILA&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;TEQUILAS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;(LIQUE|AMARETTO|TRIPLE SEC)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;LIQUEURS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;BRAND(I|Y)&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;BRANDIES&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;GIN&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;GINS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> REGEXP_CONTAINS(iowa.category_name, r</span><span style="color: #A31515">&#39;SCHNAP&#39;</span><span style="color: #000000">) </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;SCHNAPPS&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;OTHER&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000">)=</span><span style="color: #A31515">&#39;VODKAS&#39;</span><span style="color: #000000">)))</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">5</span><span style="color: #000000">,</span><span style="color: #098658">6</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  ANY_VALUE(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> vendor_count__0 </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> vendor_count,</span></span>
<span class="line"><span style="color: #000000">  ANY_VALUE(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> total_sale_dollars__0 </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_sale_dollars,</span></span>
<span class="line"><span style="color: #000000">  ANY_VALUE(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> total_bottles__0 </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_bottles,</span></span>
<span class="line"><span style="color: #000000">  ARRAY_AGG(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> STRUCT(</span></span>
<span class="line"><span style="color: #000000">    vendor_name__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> vendor_name, </span></span>
<span class="line"><span style="color: #000000">    item_description__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> item_description, </span></span>
<span class="line"><span style="color: #000000">    total_sale_dollars__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_sale_dollars, </span></span>
<span class="line"><span style="color: #000000">    total_bottles__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_bottles, </span></span>
<span class="line"><span style="color: #000000">    avg_price_per_100ml__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> avg_price_per_100ml, </span></span>
<span class="line"><span style="color: #000000">    percent_of_sales__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> percent_of_sales</span></span>
<span class="line"><span style="color: #000000">    ) </span><span style="color: #0000FF">END</span><span style="color: #000000"> IGNORE NULLS  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  total_sale_dollars__1 </span><span style="color: #0000FF">desc</span><span style="color: #000000">  </span><span style="color: #0000FF">LIMIT</span><span style="color: #000000"> </span><span style="color: #098658">5</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> top_sellers_by_revenue</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>