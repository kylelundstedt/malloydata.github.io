---
layout: documentation
title: Malloy Documentation
footer: /generated/footers/patterns/foreign_sums.html
---

<div class="document">
      <h1>
        <a id="foreign-sums" class="header-link anchor" href="#foreign-sums">
          Foreign Sums
        </a>
      </h1>
    <p>Malloy allows you to compute sums, averages correctly based on your join tree.  This example has flights, joining to aircraft, joining to aircraft_model.
<code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">aircraft_model</span></span></code> has the number of seats specified on this model of aircraft.  Code below computes sums and averages at various places in the join tree.</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #008000">// join 3 tables, flights, aircraft and aircraft models.</span></span>
<span class="line"><span style="color: #008000">// `flights` is individual flights</span></span>
<span class="line"><span style="color: #008000">// `aircraft` is the plane that made the flight</span></span>
<span class="line"><span style="color: #008000">// `aircraft_models` is data about the kind of aircraft</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">aircraft_models</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.faa.aircraft_models&#39;</span><span style="color: #000000">) {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">primary_key</span><span style="color: #000000">: </span><span style="color: #001080">aircraft_model_code</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">aircraft</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.faa.aircraft&#39;</span><span style="color: #000000">) {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">primary_key</span><span style="color: #000000">: </span><span style="color: #001080">tail_num</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">aircraft_models</span><span style="color: #000000"> </span><span style="color: #AF00DB">with</span><span style="color: #000000"> </span><span style="color: #001080">aircraft_model_code</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">flights</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.faa.flights&#39;</span><span style="color: #000000">) {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">aircraft</span><span style="color: #000000"> </span><span style="color: #AF00DB">with</span><span style="color: #000000"> </span><span style="color: #001080">tail_num</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">flights</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">dep_time</span><span style="color: #000000"> = </span><span style="color: #098658">@2003-01</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">carrier</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">// number of flights</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">flight_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">// number of planes</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">aircraft_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">aircraft</span><span style="color: #000000">.</span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">// number of different aircraft_models</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">aircraft_model_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">aircraft</span><span style="color: #000000">.</span><span style="color: #001080">aircraft_models</span><span style="color: #000000">.</span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">// count each seat once for each flight.</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">seats_for_sale</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">sum</span><span style="color: #000000">(</span><span style="color: #001080">aircraft</span><span style="color: #000000">.</span><span style="color: #001080">aircraft_models</span><span style="color: #000000">.</span><span style="color: #001080">seats</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">// count the seat once for each plane</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">seats_on_all_planes</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">aircraft</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">(</span><span style="color: #001080">aircraft</span><span style="color: #000000">.</span><span style="color: #001080">aircraft_models</span><span style="color: #000000">.</span><span style="color: #001080">seats</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #008000">// average number of seats on each model by model</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">average_seats_per_model</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">aircraft</span><span style="color: #000000">.</span><span style="color: #001080">aircraft_models</span><span style="color: #000000">.</span><span style="color: #001080">seats</span><span style="color: #000000">.</span><span style="color: #795E26">avg</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer large">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control" selected data-result-kind="html">HTML</button>
        <button class="result-control"  data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" selected>
      <div class="result-inner">
        <table style="vertical-align: top; border-collapse: collapse; width: 100%;"><thead><tr><th style="padding: 8px; text-align: left;">carrier</th><th style="padding: 8px; text-align: right;">flight_​count</th><th style="padding: 8px; text-align: right;">aircraft_​count</th><th style="padding: 8px; text-align: right;">aircraft_​model_​count</th><th style="padding: 8px; text-align: right;">seats_​for_​sale</th><th style="padding: 8px; text-align: right;">seats_​on_​all_​planes</th><th style="padding: 8px; text-align: right;">average_​seats_​per_​model</th></tr></thead><tbody><tr><td style="padding: 8px; vertical-align: top;"><span>WN</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>81,592</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>364</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>23</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>10,984,163</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>51,595</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>110.217</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>AA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>66,786</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>351</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>69</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,374,497</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>54,407</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>21.986</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>DL</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>59,722</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>524</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>23</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>10,666,057</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>105,340</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>190.565</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>UA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>47,285</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>490</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>12</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>7,637,350</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>114,169</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>263.417</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>NW</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>41,888</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>398</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>22</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5,731,475</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>65,482</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>211.818</span></td></tr></tbody></table>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" >
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;carrier&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;WN&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;flight_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">81592</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;aircraft_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">364</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;aircraft_model_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">23</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;seats_for_sale&quot;</span><span style="color: #000000">: </span><span style="color: #098658">10984163</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;seats_on_all_planes&quot;</span><span style="color: #000000">: </span><span style="color: #098658">51595</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;average_seats_per_model&quot;</span><span style="color: #000000">: </span><span style="color: #098658">110.21739130434783</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;carrier&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;AA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;flight_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">66786</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;aircraft_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">351</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;aircraft_model_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">69</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;seats_for_sale&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4374497</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;seats_on_all_planes&quot;</span><span style="color: #000000">: </span><span style="color: #098658">54407</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;average_seats_per_model&quot;</span><span style="color: #000000">: </span><span style="color: #098658">21.985507246376812</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;carrier&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;DL&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;flight_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">59722</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;aircraft_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">524</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;aircraft_model_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">23</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;seats_for_sale&quot;</span><span style="color: #000000">: </span><span style="color: #098658">10666057</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;seats_on_all_planes&quot;</span><span style="color: #000000">: </span><span style="color: #098658">105340</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;average_seats_per_model&quot;</span><span style="color: #000000">: </span><span style="color: #098658">190.56521739130434</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;carrier&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;UA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;flight_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">47285</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;aircraft_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">490</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;aircraft_model_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">12</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;seats_for_sale&quot;</span><span style="color: #000000">: </span><span style="color: #098658">7637350</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;seats_on_all_planes&quot;</span><span style="color: #000000">: </span><span style="color: #098658">114169</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;average_seats_per_model&quot;</span><span style="color: #000000">: </span><span style="color: #098658">263.4166666666667</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;carrier&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NW&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;flight_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">41888</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;aircraft_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">398</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;aircraft_model_count&quot;</span><span style="color: #000000">: </span><span style="color: #098658">22</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;seats_for_sale&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5731475</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;seats_on_all_planes&quot;</span><span style="color: #000000">: </span><span style="color: #098658">65482</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;average_seats_per_model&quot;</span><span style="color: #000000">: </span><span style="color: #098658">211.8181818181818</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   flights.carrier </span><span style="color: #0000FF">as</span><span style="color: #000000"> carrier,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">( </span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> flight_count,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> aircraft_0.tail_num) </span><span style="color: #0000FF">as</span><span style="color: #000000"> aircraft_count,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> aircraft_models_0.aircraft_model_code) </span><span style="color: #0000FF">as</span><span style="color: #000000"> aircraft_model_count,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(aircraft_models_0.seats),</span><span style="color: #098658">0</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> seats_for_sale,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">CAST</span><span style="color: #000000">((</span></span>
<span class="line"><span style="color: #000000">    (</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">SUM</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span></span>
<span class="line"><span style="color: #000000">        (</span><span style="color: #795E26">CAST</span><span style="color: #000000">(</span><span style="color: #795E26">ROUND</span><span style="color: #000000">(</span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(aircraft_models_0.seats,</span><span style="color: #098658">0</span><span style="color: #000000">)*(</span><span style="color: #098658">1</span><span style="color: #000000">*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">), </span><span style="color: #098658">9</span><span style="color: #000000">) </span><span style="color: #0000FF">AS</span><span style="color: #000000"> </span><span style="color: #0000FF">NUMERIC</span><span style="color: #000000">) +</span></span>
<span class="line"><span style="color: #000000">        (</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">concat</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;0x&#39;</span><span style="color: #000000">, substr(to_hex(md5(</span><span style="color: #795E26">CAST</span><span style="color: #000000">(aircraft_0.tail_num </span><span style="color: #0000FF">AS</span><span style="color: #000000"> STRING))), </span><span style="color: #098658">1</span><span style="color: #000000">, </span><span style="color: #098658">15</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> int64) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">numeric</span><span style="color: #000000">) * </span><span style="color: #098658">4294967296</span><span style="color: #000000"> + </span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">concat</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;0x&#39;</span><span style="color: #000000">, substr(to_hex(md5(</span><span style="color: #795E26">CAST</span><span style="color: #000000">(aircraft_0.tail_num </span><span style="color: #0000FF">AS</span><span style="color: #000000"> STRING))), </span><span style="color: #098658">16</span><span style="color: #000000">, </span><span style="color: #098658">8</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> int64) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">numeric</span><span style="color: #000000">)) * </span><span style="color: #098658">0</span><span style="color: #000000">.</span><span style="color: #098658">000000001</span></span>
<span class="line"><span style="color: #000000">      ))</span></span>
<span class="line"><span style="color: #000000">      -</span></span>
<span class="line"><span style="color: #000000">       </span><span style="color: #795E26">SUM</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> (</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">concat</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;0x&#39;</span><span style="color: #000000">, substr(to_hex(md5(</span><span style="color: #795E26">CAST</span><span style="color: #000000">(aircraft_0.tail_num </span><span style="color: #0000FF">AS</span><span style="color: #000000"> STRING))), </span><span style="color: #098658">1</span><span style="color: #000000">, </span><span style="color: #098658">15</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> int64) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">numeric</span><span style="color: #000000">) * </span><span style="color: #098658">4294967296</span><span style="color: #000000"> + </span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">concat</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;0x&#39;</span><span style="color: #000000">, substr(to_hex(md5(</span><span style="color: #795E26">CAST</span><span style="color: #000000">(aircraft_0.tail_num </span><span style="color: #0000FF">AS</span><span style="color: #000000"> STRING))), </span><span style="color: #098658">16</span><span style="color: #000000">, </span><span style="color: #098658">8</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> int64) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">numeric</span><span style="color: #000000">)) * </span><span style="color: #098658">0</span><span style="color: #000000">.</span><span style="color: #098658">000000001</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">    )/(</span><span style="color: #098658">1</span><span style="color: #000000">*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> FLOAT64),</span><span style="color: #098658">0</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> seats_on_all_planes,</span></span>
<span class="line"><span style="color: #000000">   (</span><span style="color: #795E26">CAST</span><span style="color: #000000">((</span></span>
<span class="line"><span style="color: #000000">    (</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">SUM</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span></span>
<span class="line"><span style="color: #000000">        (</span><span style="color: #795E26">CAST</span><span style="color: #000000">(</span><span style="color: #795E26">ROUND</span><span style="color: #000000">(</span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(aircraft_models_0.seats,</span><span style="color: #098658">0</span><span style="color: #000000">)*(</span><span style="color: #098658">1</span><span style="color: #000000">*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">), </span><span style="color: #098658">9</span><span style="color: #000000">) </span><span style="color: #0000FF">AS</span><span style="color: #000000"> </span><span style="color: #0000FF">NUMERIC</span><span style="color: #000000">) +</span></span>
<span class="line"><span style="color: #000000">        (</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">concat</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;0x&#39;</span><span style="color: #000000">, substr(to_hex(md5(</span><span style="color: #795E26">CAST</span><span style="color: #000000">(aircraft_models_0.aircraft_model_code </span><span style="color: #0000FF">AS</span><span style="color: #000000"> STRING))), </span><span style="color: #098658">1</span><span style="color: #000000">, </span><span style="color: #098658">15</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> int64) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">numeric</span><span style="color: #000000">) * </span><span style="color: #098658">4294967296</span><span style="color: #000000"> + </span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">concat</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;0x&#39;</span><span style="color: #000000">, substr(to_hex(md5(</span><span style="color: #795E26">CAST</span><span style="color: #000000">(aircraft_models_0.aircraft_model_code </span><span style="color: #0000FF">AS</span><span style="color: #000000"> STRING))), </span><span style="color: #098658">16</span><span style="color: #000000">, </span><span style="color: #098658">8</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> int64) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">numeric</span><span style="color: #000000">)) * </span><span style="color: #098658">0</span><span style="color: #000000">.</span><span style="color: #098658">000000001</span></span>
<span class="line"><span style="color: #000000">      ))</span></span>
<span class="line"><span style="color: #000000">      -</span></span>
<span class="line"><span style="color: #000000">       </span><span style="color: #795E26">SUM</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> (</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">concat</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;0x&#39;</span><span style="color: #000000">, substr(to_hex(md5(</span><span style="color: #795E26">CAST</span><span style="color: #000000">(aircraft_models_0.aircraft_model_code </span><span style="color: #0000FF">AS</span><span style="color: #000000"> STRING))), </span><span style="color: #098658">1</span><span style="color: #000000">, </span><span style="color: #098658">15</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> int64) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">numeric</span><span style="color: #000000">) * </span><span style="color: #098658">4294967296</span><span style="color: #000000"> + </span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">cast</span><span style="color: #000000">(</span><span style="color: #795E26">concat</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;0x&#39;</span><span style="color: #000000">, substr(to_hex(md5(</span><span style="color: #795E26">CAST</span><span style="color: #000000">(aircraft_models_0.aircraft_model_code </span><span style="color: #0000FF">AS</span><span style="color: #000000"> STRING))), </span><span style="color: #098658">16</span><span style="color: #000000">, </span><span style="color: #098658">8</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> int64) </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">numeric</span><span style="color: #000000">)) * </span><span style="color: #098658">0</span><span style="color: #000000">.</span><span style="color: #098658">000000001</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">    )/(</span><span style="color: #098658">1</span><span style="color: #000000">*</span><span style="color: #098658">1</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">)) </span><span style="color: #0000FF">as</span><span style="color: #000000"> FLOAT64))/</span><span style="color: #795E26">NULLIF</span><span style="color: #000000">(</span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> aircraft_models_0.aircraft_model_code),</span><span style="color: #098658">0</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> average_seats_per_model</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.faa.flights`</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> flights</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.faa.aircraft`</span><span style="color: #000000"> </span><span style="color: #0000FF">AS</span><span style="color: #000000"> aircraft_0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">ON</span><span style="color: #000000"> aircraft_0.tail_num=flights.tail_num</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.faa.aircraft_models`</span><span style="color: #000000"> </span><span style="color: #0000FF">AS</span><span style="color: #000000"> aircraft_models_0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">ON</span><span style="color: #000000"> aircraft_models_0.aircraft_model_code=aircraft_0.aircraft_model_code</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> (flights.dep_time&gt;=</span><span style="color: #0000FF">TIMESTAMP</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;2003-01-01&#39;</span><span style="color: #000000">, </span><span style="color: #A31515">&#39;UTC&#39;</span><span style="color: #000000">))</span><span style="color: #0000FF">and</span><span style="color: #000000">(flights.dep_time&lt;</span><span style="color: #0000FF">TIMESTAMP</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;2003-02-01&#39;</span><span style="color: #000000">, </span><span style="color: #A31515">&#39;UTC&#39;</span><span style="color: #000000">))</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>