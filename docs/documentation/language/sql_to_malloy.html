---
layout: documentation
title: Malloy Documentation
footer: /generated/footers/language/sql_to_malloy.html
---

<div class="document">
      <h2>
        <a id="how-malloy-generates-sql" class="header-link anchor" href="#how-malloy-generates-sql">
          How Malloy Generates SQL
        </a>
      </h2>
    <p>Basic structure of a Malloy Query:</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: &lt;</span><span style="color: #AF00DB">source</span><span style="color: #000000">&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: &lt;</span><span style="color: #AF00DB">source</span><span style="color: #000000">&gt; </span><span style="color: #AF00DB">with</span><span style="color: #000000"> …</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_many</span><span style="color: #000000">: &lt;</span><span style="color: #AF00DB">source</span><span style="color: #000000">&gt; </span><span style="color: #AF00DB">on</span><span style="color: #000000"> …</span></span>
<span class="line"><span style="color: #000000">} -&gt; {</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    &lt;</span><span style="color: #001080">field</span><span style="color: #000000">/</span><span style="color: #AF00DB">dimension</span><span style="color: #000000">&gt;</span></span>
<span class="line"><span style="color: #000000">    &lt;</span><span style="color: #001080">field</span><span style="color: #000000">/</span><span style="color: #AF00DB">dimension</span><span style="color: #000000">&gt;</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    &lt;</span><span style="color: #001080">aggregation</span><span style="color: #000000">/</span><span style="color: #AF00DB">measure</span><span style="color: #000000">&gt;</span></span>
<span class="line"><span style="color: #000000">    &lt;</span><span style="color: #001080">aggregation</span><span style="color: #000000">/</span><span style="color: #AF00DB">measure</span><span style="color: #000000">&gt;</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #AF00DB">nest</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    &lt;</span><span style="color: #001080">named_query</span><span style="color: #000000"> </span><span style="color: #0000FF">OR</span><span style="color: #000000"> </span><span style="color: #001080">query_def</span><span style="color: #000000">&gt;</span></span>
<span class="line"><span style="color: #000000">    &lt;</span><span style="color: #001080">named_query</span><span style="color: #000000"> </span><span style="color: #0000FF">OR</span><span style="color: #000000"> </span><span style="color: #001080">query_def</span><span style="color: #000000">&gt;</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #AF00DB">where</span><span style="color: #000000">: &lt;</span><span style="color: #001080">filter_expression</span><span style="color: #000000">&gt;, &lt;</span><span style="color: #001080">filter_expression</span><span style="color: #000000">&gt;, …</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #AF00DB">having</span><span style="color: #000000">: &lt;</span><span style="color: #001080">aggregate_filter_expression</span><span style="color: #000000">&gt;, &lt;</span><span style="color: #001080">aggregate_filter_expression</span><span style="color: #000000">&gt;</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #AF00DB">order_by</span><span style="color: #000000">: &lt;</span><span style="color: #001080">field</span><span style="color: #000000">/</span><span style="color: #AF00DB">dimension</span><span style="color: #000000">&gt;, &lt;</span><span style="color: #001080">aggregation</span><span style="color: #000000">/</span><span style="color: #AF00DB">measure</span><span style="color: #000000">&gt;, …</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #AF00DB">limit</span><span style="color: #000000">: &lt;</span><span style="color: #AF00DB">limit</span><span style="color: #000000">&gt;</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><p>This maps to the below SQL query structure:</p>
<pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">   &lt;group_by&gt;, &lt;group_by&gt;, …</span></span>
<span class="line"><span style="color: #000000">   &lt;</span><span style="color: #0000FF">aggregate</span><span style="color: #000000">&gt;, &lt;</span><span style="color: #0000FF">aggregate</span><span style="color: #000000">&gt;, …</span></span>
<span class="line"><span style="color: #000000">   &lt;nest&gt;, &lt;nest&gt;, …  		       </span><span style="color: #008000">-- very much a simplification; read more in Nesting Queries doc.</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> &lt;source&gt;</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> &lt;source&gt; </span><span style="color: #0000FF">ON</span><span style="color: #000000"> …</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> &lt;source&gt; </span><span style="color: #0000FF">ON</span><span style="color: #000000"> …</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> (&lt;filter_expression&gt;) </span><span style="color: #0000FF">AND</span><span style="color: #000000"> (&lt;filter_expression&gt;) </span><span style="color: #0000FF">AND</span><span style="color: #000000"> …</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> &lt;group_by&gt;, &lt;group_by&gt;, …</span></span>
<span class="line"><span style="color: #0000FF">HAVING</span><span style="color: #000000"> &lt;aggregate_filter_expression&gt; </span><span style="color: #0000FF">AND</span><span style="color: #000000"> &lt;aggregate_filter_expression&gt; </span><span style="color: #0000FF">AND</span><span style="color: #000000"> …</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> &lt;group_by&gt; | &lt;</span><span style="color: #0000FF">aggregate</span><span style="color: #000000">&gt;</span></span>
<span class="line"><span style="color: #0000FF">LIMIT</span><span style="color: #000000"> &lt;</span><span style="color: #0000FF">limit</span><span style="color: #000000">&gt;</span></span>
<span class="line"></span></pre>
      <h2>
        <a id="sql-to-malloy" class="header-link anchor" href="#sql-to-malloy">
          SQL to Malloy
        </a>
      </h2>
    <p>This document is intended to serve as a reference for those who already know SQL and may find it helpful to map Malloy concepts and syntax to SQL.</p>

      <h3>
        <a id="components-of-a-query" class="header-link anchor" href="#components-of-a-query">
          Components of a Query
        </a>
      </h3>
    <table>
<thead>
<tr>
<th>SQL</th>

<th>Malloy</th>

<th>Description / Docs</th>
</tr>
</thead>
<tbody><tr>
<td><pre><code>userName AS user_name</code><code>malloy-data.ecomm.users AS users</code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">user_name</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">userName</span><span style="color: #000000">  </span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">users</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">malloy</span><span style="color: #000000">-</span><span style="color: #001080">data</span><span style="color: #000000">.</span><span style="color: #001080">ecomm</span><span style="color: #000000">.</span><span style="color: #001080">users</span><span style="color: #000000"> </span></span></code></pre></td>

<td><strong>AS</strong>: Names come before definitions in Malloy.</td>
</tr>

<tr>
<td><pre><code>SELECT id FROM order_items</code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">order_items</span><span style="color: #000000"> -&gt; {</span><span style="color: #AF00DB">project</span><span style="color: #000000">: </span><span style="color: #001080">id</span><span style="color: #000000">}</span></span></code></pre></td>

<td><strong>SELECT / FROM</strong>: <a href="https://malloydata.github.io/documentation/malloy_by_example.html">Malloy by Example</a></td>
</tr>

<tr>
<td><pre><code>LEFT JOIN users</code><code> ON users.id = order_items.user_id </pre></code></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">users</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">users</span><span style="color: #000000">.</span><span style="color: #001080">id</span><span style="color: #000000"> = </span><span style="color: #001080">order_items</span><span style="color: #000000">.</span><span style="color: #001080">user_id</span></span></code></pre></td>

<td><strong>JOIN</strong>: <a href="https://malloydata.github.io/documentation/language/join.html">Documentation</a> covers more join types and complex relationships. <a href="https://malloydata.github.io/documentation/language/sql_to_malloy.html#more-complex-example">Example</a></td>
</tr>

<tr>
<td><pre><code> SELECT </code> <code>  status</code> <code>  , COUNT(*) AS items_count</code> <code>FROM order_items </code> <code>GROUP BY 1</code> </code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">order_items</span><span style="color: #000000"> -&gt; {</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">status</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">items_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">}</span></span></code></pre></td>

<td><strong>GROUP BY</strong>: Any field included in Malloy’s group_by selection will be included in both the generated <code>SELECT</code> and <code>GROUP BY</code>.</td>
</tr>

<tr>
<td><pre><code>WHERE status = 'Complete'</code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">status</span><span style="color: #000000"> = </span><span style="color: #A31515">&#39;Complete&#39;</span></span></code></pre></td>

<td><strong>WHERE</strong></td>
</tr>

<tr>
<td><pre><code>ORDER BY flight_count, avg_elevation</code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">order_by</span><span style="color: #000000">: </span><span style="color: #001080">flight_count</span><span style="color: #000000">, </span><span style="color: #795E26">avg</span><span style="color: #000000">(</span><span style="color: #001080">elevation</span><span style="color: #000000">)</span></span></code></pre></td>

<td><strong>ORDER BY</strong>. By default, <code>ORDER BY</code> is generated following <a href="https://malloydata.github.io/documentation/language/order_by.html">implicit rules</a>; this can be overridden.</td>
</tr>

<tr>
<td><pre><code>HAVING flight_count > 5</code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">having</span><span style="color: #000000">: </span><span style="color: #001080">flight_count</span><span style="color: #000000"> &gt; </span><span style="color: #098658">5</span></span></code></pre></td>

<td><strong>HAVING</strong></td>
</tr>

<tr>
<td><pre> <code>LIMIT 100</code> <code>TOP 100</code> </pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">limit</span><span style="color: #000000">: </span><span style="color: #098658">100</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">top</span><span style="color: #000000">: </span><span style="color: #098658">100</span></span></code></pre></td>

<td><strong>LIMIT / TOP</strong>: Both are accepted.</td>
</tr>

<tr>
<td><pre><code>SELECT</code> <code>  ...</code> <code>FROM (</code> <code>  SELECT</code> <code>    ...</code> <code>  FROM order_items</code> <code>)</code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">order_items</span><span style="color: #000000"> -&gt; {...} -&gt; {...}</span></span></code></pre></td>

<td><strong>Pipelines</strong> allow the output of one query to be used as the input to the next.</td>
</tr>

<tr>
<td><pre><code>FROM (...) AS user_facts</code></pre></td>

<td><pre> sql: user_facts is  { ... } </pre></td>

<td><strong>Subqueries</strong> Can be written into <a href="https://malloydata.github.io/documentation/language/sql_blocks.html">SQL Blocks</a>. Example below</td>
</tr>

<tr>
<td><pre><code> WITH user_facts AS (...) … </code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">user_facts</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">from</span><span style="color: #000000">(...)</span></span></code> </pre></td>

<td><strong>CTEs</strong>: can be generated through <a href="https://malloydata.github.io/documentation/language/basic.html#pipelines-and-multi-stage-queries">Pipelines</a> and <a href="https://malloydata.github.io/documentation/language/source.html#sources-from-queries">Sources from queries</a>.</td>
</tr>

<tr>
<td><pre><code>FROM (...) AS user_facts</code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">sql</span><span style="color: #000000">: </span><span style="color: #001080">user_facts</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> { ... }</span></span></code> </pre></td>

<td><strong>Subqueries</strong> Can be written into <a href="https://malloydata.github.io/documentation/language/sql_blocks.html">SQL Blocks</a>. Example below</td>
</tr>

<tr>
<td><pre><code> WITH user_facts AS (...) … </code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">user_facts</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">from</span><span style="color: #000000">(...)</span></span></code> </pre></td>

<td><strong>CTEs</strong>: can be generated through <a href="https://malloydata.github.io/documentation/language/basic.html#pipelines-and-multi-stage-queries">Pipelines</a> and <a href="https://malloydata.github.io/documentation/language/source.html#sources-from-queries">Sources from queries</a>.</td>
</tr>
</tbody></table>

      <h3>
        <a id="expressions" class="header-link anchor" href="#expressions">
          Expressions
        </a>
      </h3>
    <p>Many SQL functions supported by the database can simply be used unchanged in Malloy. In certain cases we have implemented what we feel are improvements and simplifications of certain SQL functions. This is intended to serve as a quick reference, more complete documentation can be found <a href="https://malloydata.github.io/documentation/language/expressions.html">here</a>.</p>
<table>
<thead>
<tr>
<th>SQL</th>

<th>Malloy</th>

<th>Description / Docs</th>
</tr>
</thead>
<tbody><tr>
<td><pre><code>SUM(), AVG(), MAX(), MIN(), COUNT(), etc </code></prE></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #795E26">sum</span><span style="color: #000000">(), </span><span style="color: #795E26">avg</span><span style="color: #000000">(), </span><span style="color: #795E26">max</span><span style="color: #000000">(), </span><span style="color: #795E26">min</span><span style="color: #000000">(), </span><span style="color: #795E26">count</span><span style="color: #000000">(), </span><span style="color: #001080">etc</span><span style="color: #000000">...</span></span></code> </pre></td>

<td>Basic SQL aggregations are supported verbatim, but it’s worth learning about Malloy’s additional <a href="https://malloydata.github.io/documentation/language/aggregates.html#aggregate-locality">aggregate locality</a> / <a href="https://help.looker.com/hc/en-us/articles/360023722974-A-Simple-Explanation-of-Symmetric-Aggregates-or-Why-On-Earth-Does-My-SQL-Look-Like-That-">symmetric aggregate</a> handling.</td>
</tr>

<tr>
<td><pre> <code>CASE</code> <code>  WHEN size_n < 3 THEN 'S'</code> <code>  WHEN size_n <5 THEN 'M'</code> <code>ELSE 'L' END</code> </pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">size_n</span><span style="color: #000000"> ?</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;S&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> &lt; </span><span style="color: #098658">3</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;M&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> &lt;</span><span style="color: #098658">5</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;L&#39;</span></span></code> </pre></td>

<td><a href="https://malloydata.github.io/documentation/language/expressions.html#pick-expressions">Pick</a> is Malloy’s improvement of SQL’s <code>CASE</code> statement. This example also introduces the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">?</span></span></code> <a href="https://malloydata.github.io/documentation/language/expressions.html#application">Apply</a> operator, which  "applies" a value to another value, condition, or computation. This is most often used with <a href="https://malloydata.github.io/documentation/language/expressions.html#partial-comparison">partial</a> comparisons or <a href="https://malloydata.github.io/documentation/language/expressions.html#alternation">alternations</a>.</td>
</tr>

<tr>
<td><pre> <code>COUNT(CASE WHEN status = 'Returned' THEN 1 END),</code> <code>AVG(CASE WHEN brand = 'Levi's' THEN price END)</code> </pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #795E26">count</span><span style="color: #000000">() {</span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">status</span><span style="color: #000000"> = </span><span style="color: #A31515">&#39;Returned&#39;</span><span style="color: #000000">}</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">avg_price</span><span style="color: #000000"> {</span><span style="color: #AF00DB">where</span><span style="color: #000000"> ? </span><span style="color: #001080">brand</span><span style="color: #000000"> = </span><span style="color: #A31515">&#39;Levi</span><span style="color: #EE0000">\&#39;</span><span style="color: #A31515">s&#39;</span><span style="color: #000000">}</span></span></code> </pre></td>

<td>Aggregates may be filtered using filter expressions. <a href="https://malloydata.github.io/documentation/language/expressions.html#filtered-expressions">Doc</a></td>
</tr>

<tr>
<td><pre> <code>CAST(distance AS string),</code> <code>distance::string</code> </pre></td>

<td><pre><code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">distance</span><span style="color: #000000">::</span><span style="color: #267F99">string</span></span></code></pre></td>

<td><a href="https://malloydata.github.io/documentation/language/expressions.html#safe-type-cast">Safe Type Cast</a>. Also worth reviewing <a href="https://malloydata.github.io/documentation/language/types.html">Types</a> doc.</td>
</tr>
</tbody></table>

      <h4>
        <a id="working-with-time" class="header-link anchor" href="#working-with-time">
          Working with Time
        </a>
      </h4>
    <p>The <a href="https://malloydata.github.io/documentation/language/expressions.html#time-expressions">Time Expressions</a> reference contains substantially more detail and examples.</p>
<table>
<thead>
<tr>
<th>SQL</th>

<th>Malloy</th>

<th>Docs</th>
</tr>
</thead>
<tbody><tr>
<td><pre> <code>TIMESTAMP_TRUNC(created_at, WEEK),</code> <code>DATE_TRUNC(order_items.shipped_at, MONTH)</code> </pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">created_at</span><span style="color: #000000">.</span><span style="color: #0000FF">week</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">shipped_at</span><span style="color: #000000">.</span><span style="color: #0000FF">month</span></span></code> </pre></td>

<td><a href="https://malloydata.github.io/documentation/language/expressions.html#time-truncation">Truncation</a></td>
</tr>

<tr>
<td><pre> <code>EXTRACT(DAYOFWEEK FROM shipped_at),</code> <code>EXTRACT(HOUR FROM created_at)</code></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">day_of_week</span><span style="color: #000000">(</span><span style="color: #001080">shipped_at</span><span style="color: #000000">)</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #795E26">hour</span><span style="color: #000000">(</span><span style="color: #001080">created_at</span><span style="color: #000000">)</span></span></code> </pre></td>

<td><a href="https://malloydata.github.io/documentation/language/expressions.html#time-extraction">Extraction</a></td>
</tr>

<tr>
<td><pre> <code>DATE_DIFF(DATE(CURRENT_TIMESTAMP()),DATE(created_at), DAY),</code> <code>TIMESTAMP_DIFF(TIMESTAMP(shipped_at), created_at, HOUR)</code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #795E26">days</span><span style="color: #000000">(</span><span style="color: #001080">created_at</span><span style="color: #000000"> </span><span style="color: #0000FF">to</span><span style="color: #000000"> </span><span style="color: #001080">now</span><span style="color: #000000">)</span></span></code> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #795E26">hours</span><span style="color: #000000">(</span><span style="color: #001080">created_at</span><span style="color: #000000"> </span><span style="color: #0000FF">to</span><span style="color: #000000"> </span><span style="color: #001080">shipped_at</span><span style="color: #000000">)</span></span></code> </pre></td>

<td><a href="https://malloydata.github.io/documentation/language/expressions.html#time-intervals">Date Diff / Intervals</a></td>
</tr>

<tr>
<td><pre><code>created_at >= TIMESTAMP('2003-01-01', 'UTC') AND created_at < TIMESTAMP('2004-01-01', 'UTC') </code></pre> <pre><code>created_at >= TIMESTAMP(DATETIME_SUB(DATETIME(CURRENT_TIMESTAMP()),INTERVAL 1 YEAR)) AND created_at < TIMESTAMP(DATETIME_ADD(DATETIME(TIMESTAMP(DATETIME_SUB(DATETIME( CURRENT_TIMESTAMP()),INTERVAL 1 YEAR))),INTERVAL 1 YEAR)) </code></pre> <pre><code>(EXTRACT(DAYOFWEEK FROM created_at)) NOT IN (1,7) </code></pre></td>

<td><pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">created_at</span><span style="color: #000000">: </span><span style="color: #098658">@2003</span></span></code> </pre> <br> <pre> <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">created_at</span><span style="color: #000000">: </span><span style="color: #001080">now</span><span style="color: #000000"> - </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">year</span><span style="color: #000000"> </span><span style="color: #0000FF">for</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">year</span></span></code> </pre> <br> <pre>`not(day_of_week(created_at) = 1</td>

<td>7)` </pre></td>

<td><a href="https://malloydata.github.io/documentation/language/expressions.html#time-expressions">Filter Expressions</a>, <a href="https://malloydata.github.io/documentation/language/expressions.html#application">Apply Operator</a></td>
</tr>
</tbody></table>

      <h3>
        <a id="not-supported-and-or-coming-soon" class="header-link anchor" href="#not-supported-and-or-coming-soon">
          Not Supported and/or Coming Soon
        </a>
      </h3>
    <p>Feature requests are tracked using <a href="https://github.com/malloydata/malloy/issues">Issues on Github</a>.</p>
<table>
<thead>
<tr>
<th>SQL</th>

<th>Notes</th>

<th></th>
</tr>
</thead>
<tbody><tr>
<td><pre><code>FIRST_VALUE(product_brand) OVER (PARTITION BY user_id ORDER BY created_at ASC) </code></pre></td>

<td><strong>Window Functions</strong>: For now, reach out for advice on achieving what you need (much is possible with nesting, pipelines, or <a href="https://malloydata.github.io/documentation/language/sql_blocks.html">SQL Blocks</a>). <a href="https://malloydata.github.io/documentation/language/sql_to_malloy.html#subqueries-ctes-">Example</a>.</td>

<td></td>
</tr>

<tr>
<td><em>NA</em></td>

<td>Querying arrays as nested objects</td>

<td></td>
</tr>

<tr>
<td><pre> <code>SELECT</code> <code> id</code> <code>  , ( SELECT COUNT(*)</code> <code>    FROM orders o</code> <code>    WHERE o.id <= orders.id</code> <code>    AND o.user_id = orders.user_id</code> <code>  ) as sequence_number</code> <code>FROM orders …</code></td>

<td><strong>Correlated Subqueries</strong>: coming soon; note that functionality will be dependent on the database dialect.</td>

<td></td>
</tr>
</tbody></table>

      <h3>
        <a id="full-query-examples" class="header-link anchor" href="#full-query-examples">
          Full Query Examples
        </a>
      </h3>
    <p>Many of the above concepts are best understood in the context of complete queries.</p>

      <h4>
        <a id="the-basics" class="header-link anchor" href="#the-basics">
          The Basics
        </a>
      </h4>
    <p>We’ll start with a relatively simple SQL query:</p>
<pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  TIMESTAMP_TRUNC(created_at, </span><span style="color: #795E26">DAY</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> order_date,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">SUM</span><span style="color: #000000">(sale_price) </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_sale_price,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> order_id) </span><span style="color: #0000FF">as</span><span style="color: #000000"> order_count</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.ecomm.order_items`</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span><span style="color: #000000"> created_at&gt;=</span><span style="color: #0000FF">TIMESTAMP</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;2021-01-01&#39;</span><span style="color: #000000">, </span><span style="color: #A31515">&#39;UTC&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">AND</span><span style="color: #000000"> created_at&lt;</span><span style="color: #0000FF">TIMESTAMP</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;2021-04-01&#39;</span><span style="color: #000000">, </span><span style="color: #A31515">&#39;UTC&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">AND</span><span style="color: #000000"> </span><span style="color: #0000FF">status</span><span style="color: #000000"> </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #A31515">&#39;Returned&#39;</span><span style="color: #000000">,</span><span style="color: #A31515">&#39;Cancelled&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">ASC</span></span>
<span class="line"></span></pre><p>In Malloy, this is expressed:</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.ecomm.order_items&#39;</span><span style="color: #000000">) -&gt; {</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">created_at</span><span style="color: #000000"> = </span><span style="color: #098658">@2021-Q1</span><span style="color: #000000">, </span><span style="color: #001080">status</span><span style="color: #000000"> != </span><span style="color: #A31515">&#39;Cancelled&#39;</span><span style="color: #000000"> &amp; </span><span style="color: #A31515">&#39;Returned&#39;</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">order_date</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">created_at</span><span style="color: #000000">.</span><span style="color: #0000FF">day</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #001080">total_sale_price</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">sale_price</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()            </span><span style="color: #008000">-- names come before definitions</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #001080">order_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">(</span><span style="color: #795E26">distinct</span><span style="color: #000000"> </span><span style="color: #001080">order_id</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">order_by</span><span style="color: #000000">: </span><span style="color: #001080">order_date</span><span style="color: #000000"> </span><span style="color: #AF00DB">asc</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre>
      <h4>
        <a id="more-complex-example" class="header-link anchor" href="#more-complex-example">
          More Complex Example
        </a>
      </h4>
    <pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">CASE</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (</span><span style="color: #098658">100</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">*(ii.product_retail_price-ii.cost)) / (</span><span style="color: #795E26">NULLIF</span><span style="color: #000000">(ii.product_retail_price,</span><span style="color: #098658">0</span><span style="color: #000000">)) &gt;=</span><span style="color: #098658">55</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;High (over 55%)&#39;</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> (</span><span style="color: #098658">100</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">*(ii.product_retail_price-ii.cost)) / (</span><span style="color: #795E26">NULLIF</span><span style="color: #000000">(ii.product_retail_price,</span><span style="color: #098658">0</span><span style="color: #000000">))&gt;=</span><span style="color: #098658">45</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;Medium (45% to 55%)&#39;</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;Low (up to 45%)&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">AS</span><span style="color: #000000"> gross_margin_pct_tier,</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #795E26">SUM</span><span style="color: #000000">(ii.product_retail_price) </span><span style="color: #0000FF">AS</span><span style="color: #000000"> total_retail_price,</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #795E26">AVG</span><span style="color: #000000">((ii.product_retail_price-ii.cost)) </span><span style="color: #0000FF">AS</span><span style="color: #000000"> avg_gross_margin</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.ecomm.inventory_items`</span><span style="color: #000000"> </span><span style="color: #0000FF">AS</span><span style="color: #000000"> ii</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.ecomm.order_items`</span><span style="color: #000000"> </span><span style="color: #0000FF">AS</span><span style="color: #000000"> oi</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">ON</span><span style="color: #000000"> ii.id=oi.inventory_item_id</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.ecomm.users`</span><span style="color: #000000"> </span><span style="color: #0000FF">AS</span><span style="color: #000000"> u</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">ON</span><span style="color: #000000"> oi.user_id = u.id</span></span>
<span class="line"><span style="color: #0000FF">WHERE</span></span>
<span class="line"><span style="color: #000000"> oi.status </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #A31515">&#39;Returned&#39;</span><span style="color: #000000">,</span><span style="color: #A31515">&#39;Cancelled&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">AND</span><span style="color: #000000"> (u.country=</span><span style="color: #A31515">&#39;USA&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">3</span><span style="color: #000000"> </span><span style="color: #0000FF">ASC</span></span>
<span class="line"></span></pre><p>In Malloy, this can be expressed in a query:</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">inventory_items</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.ecomm.inventory_items&#39;</span><span style="color: #000000">){</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">order_items</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.ecomm.order_items&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">id</span><span style="color: #000000"> = </span><span style="color: #001080">order_items</span><span style="color: #000000">.</span><span style="color: #001080">inventory_item_id</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">users</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.ecomm.users&#39;</span><span style="color: #000000">) </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">order_items</span><span style="color: #000000">.</span><span style="color: #001080">user_id</span><span style="color: #000000"> = </span><span style="color: #001080">users</span><span style="color: #000000">.</span><span style="color: #001080">id</span></span>
<span class="line"><span style="color: #000000">} -&gt; {</span></span>
<span class="line"><span style="color: #AF00DB">declare</span><span style="color: #000000">:					–- </span><span style="color: #AF00DB">declare</span><span style="color: #000000"> </span><span style="color: #001080">reusable</span><span style="color: #000000"> </span><span style="color: #001080">metrics</span><span style="color: #000000"> </span><span style="color: #0000FF">for</span><span style="color: #000000"> </span><span style="color: #001080">use</span><span style="color: #000000"> </span><span style="color: #001080">in</span><span style="color: #000000"> </span><span style="color: #AF00DB">query</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">gross_margin</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> (</span><span style="color: #001080">product_retail_price</span><span style="color: #000000"> - </span><span style="color: #001080">cost</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">gross_margin_pct</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #098658">100.0</span><span style="color: #000000"> * </span><span style="color: #001080">gross_margin</span><span style="color: #000000"> / </span><span style="color: #795E26">nullif</span><span style="color: #000000">(</span><span style="color: #001080">product_retail_price</span><span style="color: #000000">,</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #AF00DB">group_by</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">gross_margin_pct_tier</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">gross_margin_pct</span><span style="color: #000000"> ?</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;High (over 55%)&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> &gt;=</span><span style="color: #098658">55</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;Medium (45% to 55%)&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> &gt;=</span><span style="color: #098658">45</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;Low (up to 45%)&#39;</span></span>
<span class="line"><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">total_retail_price</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">product_retail_price</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">avg_gross_margin</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">gross_margin</span><span style="color: #000000">.</span><span style="color: #795E26">avg</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #AF00DB">where</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">order_items</span><span style="color: #000000">.</span><span style="color: #001080">status</span><span style="color: #000000"> != </span><span style="color: #A31515">&#39;Cancelled&#39;</span><span style="color: #000000"> &amp; </span><span style="color: #A31515">&#39;Returned&#39;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">users</span><span style="color: #000000">.</span><span style="color: #001080">country</span><span style="color: #000000"> = </span><span style="color: #A31515">&#39;USA&#39;</span></span>
<span class="line"><span style="color: #AF00DB">order_by</span><span style="color: #000000">: </span><span style="color: #001080">avg_gross_margin</span><span style="color: #000000"> </span><span style="color: #AF00DB">asc</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><p>Note that if we intend to query these tables and re-use these field definitions frequently, thinking about placing reusable definitions into the model will begin to save us a lot of time in the future.</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">users</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.ecomm.users&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">order_items</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.ecomm.order_items&#39;</span><span style="color: #000000">){</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">users</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">user_id</span><span style="color: #000000"> = </span><span style="color: #001080">users</span><span style="color: #000000">.</span><span style="color: #001080">id</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">dimension</span><span style="color: #000000">: </span><span style="color: #001080">valid_order</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">status</span><span style="color: #000000"> != </span><span style="color: #A31515">&#39;Cancelled&#39;</span><span style="color: #000000"> &amp; </span><span style="color: #A31515">&#39;Returned&#39;</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">inventory_items</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.ecomm.inventory_items&#39;</span><span style="color: #000000">){</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">order_items</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">id</span><span style="color: #000000"> = </span><span style="color: #001080">order_items</span><span style="color: #000000">.</span><span style="color: #001080">inventory_item_id</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">dimension</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #001080">gross_margin</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> (</span><span style="color: #001080">product_retail_price</span><span style="color: #000000"> - </span><span style="color: #001080">cost</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #001080">gross_margin_pct</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #098658">100.0</span><span style="color: #000000">* </span><span style="color: #001080">gross_margin</span><span style="color: #000000"> / </span><span style="color: #795E26">nullif</span><span style="color: #000000">(</span><span style="color: #001080">product_retail_price</span><span style="color: #000000">,</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #001080">gross_margin_pct_tier</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">gross_margin_pct</span><span style="color: #000000"> ?</span></span>
<span class="line"><span style="color: #000000">     </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;High (over 55%)&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> &gt;=</span><span style="color: #098658">55</span></span>
<span class="line"><span style="color: #000000">     </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;Medium (45% to 55%)&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> &gt;=</span><span style="color: #098658">45</span></span>
<span class="line"><span style="color: #000000">     </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;Low (up to 45%)&#39;</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">measure</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #001080">total_retail_price</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">product_retail_price</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #001080">avg_gross_margin</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">gross_margin</span><span style="color: #000000">.</span><span style="color: #795E26">avg</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">inventory_items</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">gross_margin_pct_tier</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #001080">total_retail_price</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #001080">avg_gross_margin</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">order_items</span><span style="color: #000000">.</span><span style="color: #001080">valid_order</span><span style="color: #000000">, </span><span style="color: #001080">order_items</span><span style="color: #000000">.</span><span style="color: #001080">users</span><span style="color: #000000">.</span><span style="color: #001080">country</span><span style="color: #000000"> = </span><span style="color: #A31515">&#39;USA&#39;</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">order_by</span><span style="color: #000000">: </span><span style="color: #001080">avg_gross_margin</span><span style="color: #000000"> </span><span style="color: #AF00DB">asc</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre>
      <h4>
        <a id="subqueries-ctes-" class="header-link anchor" href="#subqueries-ctes-">
          Subqueries / CTEs:
        </a>
      </h4>
    <p>How much of our sales come from repeat customers vs loyal, repeat customers? Written in SQL:</p>
<pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> user_facts </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">user_id</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #795E26">user_id</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">COUNT</span><span style="color: #000000">( </span><span style="color: #098658">1</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> lifetime_orders</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.ecomm.order_items`</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> user_facts.lifetime_orders=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;One-Time&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">ELSE</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;Repeat&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">AS</span><span style="color: #000000"> customer_category,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">SUM</span><span style="color: #000000">(order_items.sale_price) </span><span style="color: #0000FF">AS</span><span style="color: #000000"> total_sale_price,</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">COUNT</span><span style="color: #000000">(</span><span style="color: #0000FF">DISTINCT</span><span style="color: #000000"> order_items.order_id) </span><span style="color: #0000FF">AS</span><span style="color: #000000"> order_count</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">`malloy-data.ecomm.order_items`</span><span style="color: #000000"> </span><span style="color: #0000FF">AS</span><span style="color: #000000"> order_items</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> user_facts</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">ON</span><span style="color: #000000"> order_items.user_id = user_facts.user_id</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"></span></pre><p>In Malloy, the user_facts CTE becomes a source of its own, defined from a query using <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #795E26">from</span><span style="color: #000000">()</span></span></code>. Any aggregates in this query (for now, just lifetime_orders) become dimensions of that source.</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">user_facts</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">from</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.ecomm.order_items&#39;</span><span style="color: #000000">) -&gt; {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">user_id</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">lifetime_orders</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">order_items</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;malloy-data.ecomm.order_items&#39;</span><span style="color: #000000">){</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">user_facts</span><span style="color: #000000"> </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">user_id</span><span style="color: #000000"> = </span><span style="color: #001080">user_facts</span><span style="color: #000000">.</span><span style="color: #001080">user_id</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">order_items</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">customer_category</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">user_facts</span><span style="color: #000000">.</span><span style="color: #001080">lifetime_orders</span><span style="color: #000000"> ?</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">pick</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;One-Time&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">when</span><span style="color: #000000"> = </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">else</span><span style="color: #000000"> </span><span style="color: #A31515">&#39;Repeat&#39;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">total_sale_price</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">sale_price</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">order_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">(</span><span style="color: #795E26">distinct</span><span style="color: #000000"> </span><span style="color: #001080">order_id</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><p>One can also define a <a href="https://malloydata.github.io/documentation/language/sql_blocks.html">SQL block</a> to be used as a source in Malloy.</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">sql</span><span style="color: #000000">: </span><span style="color: #001080">order_facts</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">select</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color: #A31515">    SELECT</span></span>
<span class="line"><span style="color: #A31515">      order_id</span></span>
<span class="line"><span style="color: #A31515">      , user_id</span></span>
<span class="line"><span style="color: #A31515">      , ROW_NUMBER() OVER(PARTITION BY user_id ORDER BY created_at) as user_order_sequence_number</span></span>
<span class="line"><span style="color: #A31515">    FROM malloy-data.ecomm.order_items</span></span>
<span class="line"><span style="color: #A31515">  &quot;&quot;&quot;</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">sql</span><span style="color: #000000">: </span><span style="color: #001080">order_items_sql</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">select</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color: #A31515">    SELECT</span></span>
<span class="line"><span style="color: #A31515">      id</span></span>
<span class="line"><span style="color: #A31515">      , order_id</span></span>
<span class="line"><span style="color: #A31515">    , created_at</span></span>
<span class="line"><span style="color: #A31515">    FROM malloy-data.ecomm.order_items</span></span>
<span class="line"><span style="color: #A31515">    WHERE status NOT IN (&#39;Cancelled&#39;, &#39;Returned&#39;)</span></span>
<span class="line"><span style="color: #A31515">  &quot;&quot;&quot;</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">source</span><span style="color: #000000">: </span><span style="color: #001080">order_items</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">from_sql</span><span style="color: #000000">(</span><span style="color: #001080">order_items_sql</span><span style="color: #000000">){</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">join_one</span><span style="color: #000000">: </span><span style="color: #001080">order_facts</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">from_sql</span><span style="color: #000000">(</span><span style="color: #001080">order_facts</span><span style="color: #000000">) </span><span style="color: #AF00DB">on</span><span style="color: #000000"> </span><span style="color: #001080">order_id</span><span style="color: #000000"> = </span><span style="color: #001080">order_facts</span><span style="color: #000000">.</span><span style="color: #001080">order_id</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">measure</span><span style="color: #000000">: </span><span style="color: #001080">order_count</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">count</span><span style="color: #000000">(</span><span style="color: #795E26">distinct</span><span style="color: #000000"> </span><span style="color: #001080">order_id</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #001080">order_items</span><span style="color: #000000"> -&gt; {</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">order_facts</span><span style="color: #000000">.</span><span style="color: #001080">user_order_sequence_number</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">order_count</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><p>The above Malloy code will produce this SQL:</p>
<pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">   order_facts_0.user_order_sequence_number </span><span style="color: #0000FF">as</span><span style="color: #000000"> user_order_sequence_number,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">count</span><span style="color: #000000">(</span><span style="color: #0000FF">distinct</span><span style="color: #000000"> order_items.order_id) </span><span style="color: #0000FF">as</span><span style="color: #000000"> order_count</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">   id</span></span>
<span class="line"><span style="color: #000000">   , order_id</span></span>
<span class="line"><span style="color: #000000">   , created_at</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> malloy-</span><span style="color: #0000FF">data</span><span style="color: #000000">.ecomm.order_items</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> </span><span style="color: #0000FF">status</span><span style="color: #000000"> </span><span style="color: #0000FF">NOT</span><span style="color: #000000"> </span><span style="color: #0000FF">IN</span><span style="color: #000000"> (</span><span style="color: #A31515">&#39;Cancelled&#39;</span><span style="color: #000000">, </span><span style="color: #A31515">&#39;Returned&#39;</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> order_items</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">   order_id</span></span>
<span class="line"><span style="color: #000000">   , </span><span style="color: #795E26">user_id</span></span>
<span class="line"><span style="color: #000000">   , </span><span style="color: #795E26">ROW_NUMBER</span><span style="color: #000000">() </span><span style="color: #0000FF">OVER</span><span style="color: #000000">(</span><span style="color: #0000FF">PARTITION</span><span style="color: #000000"> </span><span style="color: #0000FF">BY</span><span style="color: #000000"> </span><span style="color: #795E26">user_id</span><span style="color: #000000"> </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> created_at) </span><span style="color: #0000FF">as</span><span style="color: #000000"> user_order_sequence_number</span></span>
<span class="line"><span style="color: #000000"> </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> malloy-</span><span style="color: #0000FF">data</span><span style="color: #000000">.ecomm.order_items</span></span>
<span class="line"><span style="color: #000000">) </span><span style="color: #0000FF">AS</span><span style="color: #000000"> order_facts_0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">ON</span><span style="color: #000000"> order_items.order_id=order_facts_0.order_id</span></span>
<span class="line"><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">2</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"></span></pre></div>